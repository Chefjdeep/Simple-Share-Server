<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simple Share - Mobile</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4a6fa5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Simple Share">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Simple Share">
    <link rel="icon" type="image/png" href="/static/icon-192.png">
</head>
<body>
    <!-- Splash Screen for PWA -->
    <div id="splash-screen">
        <div class="splash-logo">
            <i class="fas fa-share-alt"></i>
        </div>
        <div class="splash-text">Simple Share</div>
        <div class="splash-subtext">Loading...</div>
        <div class="splash-loader"></div>
    </div>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i> You're offline
    </div>

    <!-- Mobile App Header -->
    <div class="mobile-header">
        <div class="header-content">
            <h1><i class="fas fa-share-alt"></i> Simple Share</h1>
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-wifi"></i> Connected
            </div>
        </div>
    </div>

    <div class="mobile-container">
        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="action-btn" onclick="location.href='/';">
                <i class="fas fa-desktop"></i>
                <span>Desktop View</span>
            </button>
            <button class="action-btn" onclick="copyToClipboard('{{ network.mobile_url }}');">
                <i class="fas fa-link"></i>
                <span>Copy URL</span>
            </button>
            <button class="action-btn" onclick="refreshFiles();">
                <i class="fas fa-sync-alt"></i>
                <span>Refresh</span>
            </button>
        </div>

        <!-- Upload Section -->
        <div class="mobile-section">
            <h2><i class="fas fa-cloud-upload-alt"></i> Upload Files</h2>
            
            <div class="upload-options">
                <label class="upload-option">
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>
                    <i class="fas fa-camera"></i>
                    <span>Camera</span>
                </label>
                
                <label class="upload-option">
                    <input type="file" id="galleryInput" accept="image/*,video/*" multiple hidden>
                    <i class="fas fa-images"></i>
                    <span>Gallery</span>
                </label>
                
                <label class="upload-option">
                    <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.xls,.xlsx,.zip,.mp3,.mp4" multiple hidden>
                    <i class="fas fa-file"></i>
                    <span>Files</span>
                </label>
            </div>
            
            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">Uploading...</p>
            </div>
            
            <div class="upload-queue" id="uploadQueue"></div>
        </div>

        <!-- Recent Files -->
        <div class="mobile-section">
            <h2><i class="fas fa-history"></i> Recent Files</h2>
            
            <div class="files-list" id="filesList">
                {% for file in files %}
                <div class="file-item">
                    <div class="file-icon">
                        {% if file.name.lower().endswith(('.jpg', '.jpeg', '.png', '.gif')) %}
                        <i class="fas fa-image"></i>
                        {% elif file.name.lower().endswith(('.mp4', '.avi', '.mov')) %}
                        <i class="fas fa-video"></i>
                        {% elif file.name.lower().endswith(('.mp3', '.wav')) %}
                        <i class="fas fa-music"></i>
                        {% elif file.name.lower().endswith(('.pdf',)) %}
                        <i class="fas fa-file-pdf"></i>
                        {% else %}
                        <i class="fas fa-file"></i>
                        {% endif %}
                    </div>
                    
                    <div class="file-info">
                        <h3>{{ file.name[:20] }}{% if file.name|length > 20 %}...{% endif %}</h3>
                        <p>{{ (file.size/1024/1024)|round(2) if file.size > 1048576 else (file.size/1024)|round(1) }} {{ 'MB' if file.size > 1048576 else 'KB' }} â€¢ {{ file.upload_time }}</p>
                    </div>
                    
                    <div class="file-actions">
                        <a href="{{ file.url }}" class="download-btn" download>
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No files yet. Upload some!</p>
                </div>
                {% endfor %}
            </div>
            
            <button class="view-all-btn" onclick="location.href='/';">View All Files</button>
        </div>

        <!-- Connection Info -->
        <div class="mobile-section connection-info">
            <h2><i class="fas fa-wifi"></i> Connection</h2>
            <div class="info-card">
                <div class="info-row">
                    <span class="label">Server IP:</span>
                    <span class="value">{{ network.ip }}</span>
                </div>
                <div class="info-row">
                    <span class="label">Port:</span>
                    <span class="value">{{ network.port }}</span>
                </div>
                <div class="info-row">
                    <span class="label">Status:</span>
                    <span class="status-connected">Connected</span>
                </div>
            </div>
            
            <div class="qr-box">
                <div id="mobileQrcode"></div>
                <p class="qr-hint">Scan to share this link</p>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="location.href='/mobile';">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </button>
        <button class="nav-btn" onclick="location.href='/';">
            <i class="fas fa-list"></i>
            <span>Files</span>
        </button>
        <button class="nav-btn" onclick="showUploadOptions();">
            <i class="fas fa-plus-circle"></i>
            <span>Upload</span>
        </button>
        <button class="nav-btn" onclick="location.reload();">
            <i class="fas fa-redo"></i>
            <span>Refresh</span>
        </button>
    </div>

    <!-- Upload Modal -->
    <div class="modal" id="uploadModal" style="display: none;">
        <div class="modal-content">
            <h3>Select Files</h3>
            <div class="modal-options">
                <label class="modal-option">
                    <input type="file" id="modalCamera" accept="image/*" capture="environment" hidden>
                    <i class="fas fa-camera"></i>
                    <span>Camera</span>
                </label>
                <label class="modal-option">
                    <input type="file" id="modalPhotos" accept="image/*,video/*" multiple hidden>
                    <i class="fas fa-images"></i>
                    <span>Photos</span>
                </label>
                <label class="modal-option">
                    <input type="file" id="modalFiles" accept="*/*" multiple hidden>
                    <i class="fas fa-file"></i>
                    <span>Files</span>
                </label>
            </div>
            <button class="close-modal" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div class="toast" id="toast"></div>

    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script>
        // Generate QR Code
        document.addEventListener('DOMContentLoaded', function() {
            new QRCode(document.getElementById("mobileQrcode"), {
                text: "{{ network.mobile_url }}",
                width: 150,
                height: 150,
                colorDark: "#4a6fa5",
                colorLight: "#ffffff"
            });
            
            setupFileInputs();
            checkConnection();
            registerServiceWorker();
        });
        
        // Register Service Worker for PWA
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            }
            
            // Detect if app is installed
            window.addEventListener('appinstalled', (evt) => {
                console.log('App installed successfully!');
                showToast('App installed successfully!', 'success');
            });
            
            // Show install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install button after 3 seconds
                setTimeout(() => {
                    if (!document.getElementById('installBtn')) {
                        const installBtn = document.createElement('button');
                        installBtn.id = 'installBtn';
                        installBtn.className = 'install-prompt';
                        installBtn.innerHTML = '<i class="fas fa-download"></i> Install App';
                        installBtn.onclick = installApp;
                        document.querySelector('.mobile-header').appendChild(installBtn);
                    }
                }, 3000);
            });
        }
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted install');
                        document.getElementById('installBtn').style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // Hide splash screen when loaded
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.getElementById('splash-screen').classList.add('hidden');
                setTimeout(function() {
                    document.getElementById('splash-screen').style.display = 'none';
                }, 300);
            }, 1000);
        });
        
        // Check online/offline status
        window.addEventListener('online', function() {
            document.getElementById('offlineIndicator').classList.remove('show');
            document.getElementById('connectionStatus').classList.remove('offline');
            document.getElementById('connectionStatus').innerHTML = 
                '<i class="fas fa-wifi"></i> Connected';
        });
        
        window.addEventListener('offline', function() {
            document.getElementById('offlineIndicator').classList.add('show');
            document.getElementById('connectionStatus').classList.add('offline');
            document.getElementById('connectionStatus').innerHTML = 
                '<i class="fas fa-wifi-slash"></i> Offline';
        });
        
        function setupFileInputs() {
            // Camera input
            document.getElementById('cameraInput').addEventListener('change', function(e) {
                uploadFiles(e.target.files);
                e.target.value = '';
            });
            
            // Gallery input
            document.getElementById('galleryInput').addEventListener('change', function(e) {
                uploadFiles(e.target.files);
                e.target.value = '';
            });
            
            // File input
            document.getElementById('fileInput').addEventListener('change', function(e) {
                uploadFiles(e.target.files);
                e.target.value = '';
            });
            
            // Modal inputs
            document.getElementById('modalCamera').addEventListener('change', function(e) {
                uploadFiles(e.target.files);
                closeModal();
                e.target.value = '';
            });
            
            document.getElementById('modalPhotos').addEventListener('change', function(e) {
                uploadFiles(e.target.files);
                closeModal();
                e.target.value = '';
            });
            
            document.getElementById('modalFiles').addEventListener('change', function(e) {
                uploadFiles(e.target.files);
                closeModal();
                e.target.value = '';
            });
        }
        
        async function uploadFiles(files) {
            if (files.length === 0) return;
            
            const progress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const queue = document.getElementById('uploadQueue');
            
            progress.style.display = 'block';
            queue.innerHTML = '';
            
            // Show files in queue
            for (let file of files) {
                queue.innerHTML += `
                    <div class="queue-item">
                        <i class="fas fa-file"></i>
                        <span>${file.name}</span>
                        <span class="file-size">(${formatFileSize(file.size)})</span>
                    </div>
                `;
            }
            
            // Upload each file
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);
                
                progressText.textContent = `Uploading ${i + 1}/${files.length}`;
                progressFill.style.width = `${((i + 1) / files.length) * 100}%`;
                
                try {
                    const response = await fetch('/mobile_upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const queueItems = document.querySelectorAll('.queue-item');
                        queueItems[i].innerHTML += '<i class="fas fa-check success"></i>';
                    }
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    showToast('Upload failed', 'error');
                }
            }
            
            // Complete
            progressText.textContent = 'Upload complete!';
            progressFill.style.width = '100%';
            
            setTimeout(() => {
                progress.style.display = 'none';
                queue.innerHTML = '';
                refreshFiles();
            }, 2000);
            
            showToast(`Uploaded ${files.length} file(s)`, 'success');
        }
        
        function refreshFiles() {
            location.reload();
        }
        
        function showUploadOptions() {
            document.getElementById('uploadModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('uploadModal').style.display = 'none';
        }
        
        function checkConnection() {
            fetch('/')
                .then(() => {
                    document.getElementById('connectionStatus').innerHTML = 
                        '<i class="fas fa-wifi"></i> Connected';
                })
                .catch(() => {
                    document.getElementById('connectionStatus').innerHTML = 
                        '<i class="fas fa-wifi-slash"></i> Disconnected';
                });
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard!', 'success');
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // Close modal on back button
        window.addEventListener('popstate', function() {
            closeModal();
        });
    </script>
</body>
</html>